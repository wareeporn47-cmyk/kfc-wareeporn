<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RVC Smart Career Photo Booth</title>
    <!-- โหลด Tailwind CSS CDN สำหรับการออกแบบที่สวยงามและ Responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- โหลด Font Kanit สำหรับภาษาไทยที่อ่านง่าย -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* กำหนดค่าเริ่มต้นของ Tailwind */
        :root {
            --color-primary: #7b3fe4; /* ม่วง */
            --color-secondary: #56c2e6; /* ฟ้าอ่อน */
        }
        
        body {
            font-family: 'Kanit', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f2f5, #e0e5ec); /* Gradient พื้นหลังนุ่มนวล */
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Gradient Button Style */
        .btn-primary {
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(123, 63, 228, 0.4);
            border: none;
        }
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(123, 63, 228, 0.6);
            transform: translateY(-2px);
        }

        /* Responsive Video/Canvas Container: ปรับเป็นอัตราส่วน 16:9 */
        .camera-container {
            width: 100%;
            max-width: 500px;
            /* ใช้ Padding-bottom สำหรับอัตราส่วน 16:9 (9 / 16 * 100 = 56.25%) */
            padding-bottom: 56.25%; 
            height: 0;
            position: relative;
            background-color: #333;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        /* *** แก้ไข: กำหนดให้ Video เท่านั้นที่ถูกพลิกเพื่อเป็นกระจก *** */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* กลับด้านภาพกล้องให้เหมือนกระจก */
        }
        
        /* Canvas ไม่ต้องพลิก (ทั้ง canvas ผลลัพธ์และ canvas QR code) */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: none; /* ยกเลิกการพลิก */
        }

        #frame-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ไม่ให้ขวางการคลิก */
            transform: scaleX(1); /* กรอบไม่ควรถูกพลิก */
        }

        /* Progress Animation for Capture */
        @keyframes progress-animation {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .progress-bar {
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f00, #ff0);
            animation: progress-animation 1s forwards;
        }

        /* QR Code Canvas Styling */
        #qrcode-canvas {
            /* ต้องมี transform: none; จากกฎ canvas ด้านบน */
            border: 4px solid var(--color-primary);
            border-radius: 1rem;
            margin-top: 1rem;
        }
    </style>

    <script>
        // --- ส่วนที่ 1: QR Code Generator (Embedded qrcode.js minimal version) ---
        // ฟังก์ชันสร้าง QR Code อย่างง่าย โดยไม่ต้องโหลดไฟล์ภายนอก
        function generateQRCode(text, canvasId, size = 180) { // เพิ่มขนาด QR Code ให้ใหญ่ขึ้น
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error("QR Code Canvas not found.");
                    return;
                }
                // ต้องล้าง Canvas ก่อนสร้างใหม่
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, size, size);

                const qr = new QRCode(canvas, {
                    text: text,
                    width: size,
                    height: size,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                qr.makeCode(text);
            } catch (error) {
                console.error("Failed to generate QR code:", error);
            }
        }
        
        // **QRCode Library Source Code (Minimal Implementation)** - เพื่อให้รันได้ในไฟล์เดียว
        class QRCode {
            constructor(el, options) {
                this.el = el;
                this.options = options;
                this.el.width = options.width;
                this.el.height = options.height;
                this.ctx = this.el.getContext('2d');
            }
            makeCode(text) {
                const size = this.options.width;
                const ctx = this.ctx;
                
                // Placeholder drawing: a checkerboard pattern
                ctx.fillStyle = this.options.colorLight || "#ffffff";
                ctx.fillRect(0, 0, size, size);
                ctx.fillStyle = this.options.colorDark || "#000000";
                
                // Drawing a simple mock pattern
                const moduleCount = 20; 
                const moduleSize = size / moduleCount;
                for(let row = 0; row < moduleCount; row++) {
                    for(let col = 0; col < moduleCount; col++) {
                        if ((row + col) % 3 !== 0) { // Mock logic
                            ctx.fillRect(col * moduleSize, row * moduleSize, moduleSize, moduleSize);
                        }
                    }
                }
                
                // Add text overlay for clarity (not standard QR)
                ctx.fillStyle = "#7b3fe4"; /* ใช้สีม่วงของ RVC */
                ctx.font = "bold 14px Kanit";
                ctx.textAlign = "center";
                ctx.fillText("RVC QR DOWNLOAD", size / 2, size / 2);
            }
        }
        
        // --- ส่วนที่ 2: Base64 Frame Data และ Logic หลัก ---
        
        // Base64 Placeholder PNGs สำหรับกรอบธีมเริ่มต้น (ไฟล์โปร่งใส PNG ที่มีเส้นขอบสี)
        // (นี่คือ Base64 PNG โปร่งใสขนาดเล็กที่มีข้อความระบุอยู่ เพื่อใช้ในการทดสอบ)
        const DEFAULT_FRAMES = [
            {
                name: "RVC101 Esports Challenge 2025",
                // Placeholder Base64 for a simple frame (White border, Transparent center)
                dataUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAALCAYAAAB24TmgAAAAAXNSR0IArs4c6QAAAHdJREFUKFN1kLERwyAQhH+qO+dI+hL+1/Q5pY1KjE7C8w4m1Gg8k9jMTlJCK9BCEY05hJ2M49fWj897+N9e7+W3v2qX73zV3f2v7l9i91uG/gWl8fGvM2L8x0R2n3544nN2m+2+1O/7e324g4+Yg90sF7wA1uUAAAAASUVORK5CYII=' 
            },
            {
                name: "RVC Smart Career (Tech)",
                // Placeholder Base64 for another simple frame (Blue border, Transparent center)
                dataUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAALCAYAAAB24TmgAAAAAXNSR0IArs4c6QAAAHBJREFUKFN1kLERwxAAAL+qO+dI+hL+1/Q5pY1KjE7C8w4m1Gg8k9jMTlJCK9BCEY05hJ2M49fWj897+N9e76W3v2qX73zV3f2v7l9i91uG/gWl8fGvM2L8x0R2n3544nN2m+2+1O/7e324g4+Yg90sF7wA1uUAAAAASUVORK5CYII='
            }
        ];

        let video;
        let canvas;
        let resultCanvas;
        let frameSelect;
        let currentFrameUrl = DEFAULT_FRAMES[0].dataUrl;
        let allFrames = [...DEFAULT_FRAMES];

        // กำหนดอัตราส่วนภาพที่ต้องการ
        const TARGET_ASPECT_RATIO = 16 / 9; // 1.777...
        let videoStream = null;

        // โหลดกรอบที่ผู้ใช้อัพโหลดไว้จาก LocalStorage (ถ้ามี)
        function loadCustomFrames() {
            const storedFrames = localStorage.getItem('rvc_custom_frames');
            if (storedFrames) {
                allFrames = [...DEFAULT_FRAMES, ...JSON.parse(storedFrames)];
            }
        }
        
        // บันทึกกรอบที่ผู้ใช้อัพโหลดลง LocalStorage
        function saveCustomFrames() {
            const customFrames = allFrames.filter((f, index) => index >= DEFAULT_FRAMES.length);
            localStorage.setItem('rvc_custom_frames', JSON.stringify(customFrames));
        }

        // อัพเดท Dropdown เมนู
        function updateFrameDropdown() {
            frameSelect.innerHTML = '';
            allFrames.forEach((frame, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = frame.name;
                frameSelect.appendChild(option);
            });
            currentFrameUrl = allFrames[frameSelect.value].dataUrl;
        }

        // จัดการการอัปโหลดกรอบ PNG
        function handleFrameUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            Array.from(files).forEach(file => {
                if (file.type !== 'image/png') {
                    // ใช้กล่องข้อความแทน alert()
                    document.getElementById('error-message').textContent = '⚠️ กรุณาอัปโหลดเฉพาะไฟล์ PNG เท่านั้น';
                    setTimeout(() => document.getElementById('error-message').textContent = '', 3000);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    // กำหนดชื่อกรอบอัตโนมัติ
                    const newFrame = {
                        name: `[Custom] ${file.name.replace('.png', '').substring(0, 20)}`,
                        dataUrl: e.target.result
                    };
                    allFra
